<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Homeschool Time Tracker</title>
<style>
/* Responsive base styles */
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
       max-width: 1400px; margin: 0 auto; padding: 10px; background: #f5f5f5; }
h1 { color: #333; margin: 10px 0; font-size: clamp(18px, 5vw, 24px); }

/* Container - responsive grid */
.container { display: grid; grid-template-columns: 1fr; gap: 15px; }
@media (min-width: 768px) {
  .container { grid-template-columns: 250px 1fr; padding: 20px; }
  body { padding: 20px; }
}

.sidebar { display: flex; flex-direction: column; gap: 15px; }
.panel { background: white; border: 1px solid #ddd; padding: 15px; border-radius: 8px;
         box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
.main-panel { background: white; border: 1px solid #ddd; padding: 15px; border-radius: 8px; }

/* Buttons - touch-friendly */
button { background: #4CAF50; color: white; border: none; padding: 12px 15px;
         cursor: pointer; border-radius: 6px; font-size: 14px; width: 100%; margin-bottom: 5px;
         font-weight: 500; touch-action: manipulation; }
button:hover, button:active { opacity: 0.9; }
button.secondary { background: #008CBA; }
button.stop { background: #f44336; }
button.pause { background: #FF9800; }
button.hidden { display: none; }

/* Text areas */
textarea { width: 100%; box-sizing: border-box; font-family: 'Courier New', monospace;
           padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;
           line-height: 1.6; min-height: 300px; resize: vertical; }
@media (min-width: 768px) {
  textarea { min-height: 400px; }
}

/* Status */
#status { background: #e7f3ff; padding: 12px; border-radius: 6px; margin-bottom: 15px;
          font-weight: 500; min-height: 20px; border: 2px solid #0066cc; color: #004085; }
#status.running { background: #d4edda; border-color: #28a745; color: #155724; }

/* File list */
#fileList { list-style: none; padding: 0; margin: 10px 0 0 0; max-height: 300px; overflow-y: auto;
            background: white; border: 1px solid #ddd; border-radius: 6px; }
#fileList li { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; font-size: 13px; }
#fileList li:hover, #fileList li:active { background: #e3f2fd; }
#fileList li.active { background: #4CAF50; color: white; font-weight: bold; }

/* Tabs */
.tabs { display: flex; gap: 2px; margin-bottom: 15px; border-bottom: 2px solid #ddd; overflow-x: auto; }
.tab { padding: 12px 15px; cursor: pointer; border: none; background: transparent;
       color: #666; font-size: 14px; border-bottom: 3px solid transparent; white-space: nowrap; }
.tab:hover { background: #f0f0f0; color: #333; }
.tab.active { color: #4CAF50; border-bottom-color: #4CAF50; font-weight: 600; }
.tab-content { display: none; }
.tab-content.active { display: block; }

/* Settings */
.settings-editors { display: grid; grid-template-columns: 1fr; gap: 15px; }
@media (min-width: 768px) {
  .settings-editors { grid-template-columns: 1fr 1fr; gap: 20px; }
}
.editor-section { border: 1px solid #ddd; padding: 15px; border-radius: 6px; background: #fafafa; }
.editor-section h3 { margin-top: 0; color: #4CAF50; font-size: 16px; }
.editor-section textarea { min-height: 250px; font-size: 13px; background: white; }

/* Help */
.help { background: #e3f2fd; padding: 12px; border-radius: 6px; margin-bottom: 15px;
        font-size: 13px; line-height: 1.5; border-left: 4px solid #2196F3; }
.help strong { display: block; margin-bottom: 5px; color: #1976D2; }

/* Autocomplete */
#autocomplete { position: fixed; background: white; border: 2px solid #4CAF50;
                border-radius: 6px; max-height: 200px; overflow-y: auto; z-index: 1000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2); display: none; min-width: 200px;
                max-width: 90vw; }
#autocomplete div { padding: 10px 12px; cursor: pointer; border-bottom: 1px solid #eee; }
#autocomplete div:hover, #autocomplete div:active { background: #e3f2fd; }
#autocomplete div.selected { background: #4CAF50; color: white; }
#autocomplete .tag { font-weight: bold; color: #2196F3; }
#autocomplete .desc { font-size: 12px; color: #666; margin-left: 8px; }
#autocomplete div.selected .tag, #autocomplete div.selected .desc { color: white; }

/* Storage mode indicator */
.storage-mode { padding: 8px 12px; background: #f0f0f0; border-radius: 6px; font-size: 12px;
                text-align: center; margin-bottom: 10px; color: #666; }
.storage-mode.desktop { background: #d4edda; color: #155724; }
.storage-mode.mobile { background: #fff3cd; color: #856404; }

h2 { margin: 0 0 10px 0; font-size: 16px; color: #333; }
h3 { margin: 0 0 10px 0; font-size: 16px; color: #333; }

/* Footer */
.footer { margin-top: 60px; padding-top: 20px; border-top: 2px solid #ddd; text-align: center; color: #666; }
.footer a { color: #2196F3; text-decoration: none; }
.footer a:hover { text-decoration: underline; }

/* Help link */
.help-link { display: inline-block; background: #2196F3; color: white; padding: 6px 12px;
             border-radius: 5px; text-decoration: none; font-size: 12px; font-weight: bold;
             margin-left: 10px; }
.help-link:hover { background: #1976D2; text-decoration: none; }
</style>
</head>
<body>

<h1>üìö Homeschool Time Tracker <a href="docs/" class="help-link">üìñ Help</a></h1>

<div id="storageModeIndicator" class="storage-mode">Detecting platform...</div>

<div class="container">
  <!-- Sidebar -->
  <div class="sidebar">
    <!-- Timer Controls -->
    <div class="panel">
      <h2>‚è±Ô∏è Timer</h2>
      <button id="startBtn" onclick="startTimer()">‚ñ∂Ô∏è Start Timer</button>
      <button id="pauseBtn" onclick="pauseTimer()" class="pause hidden">‚è∏Ô∏è Pause Timer</button>
      <button id="stopBtn" onclick="stopTimer()" class="stop hidden">‚èπÔ∏è Stop Timer</button>
      <button onclick="insertTimerLine()" class="secondary">‚ûï New Timer Entry</button>
    </div>

    <!-- File Management -->
    <div class="panel">
      <h2>üìã Files</h2>
      <button id="selectFolderBtn" onclick="selectFolder()" class="hidden">üìÅ Select Folder</button>
      <button id="createFolderBtn" onclick="createNewFolder()" class="hidden">üÜï Create New Folder</button>
      <button onclick="createTodayLog()">üìÑ Today's Log</button>
      <button onclick="saveCurrentLog()" class="secondary">üíæ Save</button>
      <button onclick="refreshFileList()" class="secondary">üîÑ Refresh</button>
      <button onclick="exportJSON()" class="secondary">‚¨áÔ∏è Export JSON</button>
      <button onclick="importJSON()" class="secondary">‚¨ÜÔ∏è Import JSON</button>
      <input type="file" id="jsonFileInput" accept=".json" style="display:none" onchange="handleJSONImport(event)">
      <ul id="fileList"></ul>
    </div>
  </div>

  <!-- Main Panel -->
  <div class="main-panel">
    <!-- Tab Navigation -->
    <div class="tabs">
      <button class="tab active" onclick="switchTab('logs')">üìã Logs</button>
      <button class="tab" onclick="switchTab('settings')">‚öôÔ∏è Settings</button>
    </div>

    <!-- Logs Tab -->
    <div id="logsTab" class="tab-content active">
      <div id="status">Type or insert a timer entry, then click Start Timer</div>

      <div class="help">
        <strong>How to use:</strong>
        1. Type: <code>- [Timer] #student #subject</code><br>
        2. Click "Start Timer"<br>
        3. Click "Stop Timer" when done<br>
        <strong>Autocomplete:</strong> Type <code>#</code> to see all tags
      </div>

      <h3>üìù <span id="currentFile">No file loaded</span></h3>
      <textarea id="logEditor" placeholder="Loading..."></textarea>
    </div>

    <!-- Settings Tab -->
    <div id="settingsTab" class="tab-content">
      <h3>‚úèÔ∏è Edit Students & Subjects</h3>
      <p style="margin-bottom: 15px; color: #666;">Format: <code>#tagname - Description</code></p>

      <div class="settings-editors">
        <div class="editor-section">
          <h3>üë• Students</h3>
          <select id="studentsFileSelect" onchange="loadSelectedStudentFile()" style="width: 100%; padding: 8px; margin-bottom: 10px; border-radius: 6px; border: 1px solid #ddd;">
            <option value="students.md">students.md</option>
          </select>
          <button onclick="createNewStudentFile()" class="secondary" style="margin-bottom: 10px;">‚ûï New File</button>
          <textarea id="studentsEditor" placeholder="Loading..."></textarea>
          <button onclick="saveStudents()" style="margin-top: 10px;">üíæ Save</button>
          <button onclick="deleteStudentFile()" class="stop" style="margin-top: 10px;">üóëÔ∏è Delete File</button>
        </div>

        <div class="editor-section">
          <h3>üìö Subjects</h3>
          <select id="subjectsFileSelect" onchange="loadSelectedSubjectFile()" style="width: 100%; padding: 8px; margin-bottom: 10px; border-radius: 6px; border: 1px solid #ddd;">
            <option value="subjects.md">subjects.md</option>
          </select>
          <button onclick="createNewSubjectFile()" class="secondary" style="margin-bottom: 10px;">‚ûï New File</button>
          <textarea id="subjectsEditor" placeholder="Loading..."></textarea>
          <button onclick="saveSubjects()" style="margin-top: 10px;">üíæ Save</button>
          <button onclick="deleteSubjectFile()" class="stop" style="margin-top: 10px;">üóëÔ∏è Delete File</button>
        </div>
      </div>

      <div style="margin-top: 30px; padding: 15px; background: #f0f0f0; border-radius: 6px;">
        <h3 style="margin-top: 0;">üìä Export Data</h3>
        <button onclick="exportCSV()" class="secondary">‚¨áÔ∏è Export CSV Report</button>
        <p style="font-size: 12px; color: #666; margin-top: 10px;">
          Exports all logged time with totals per student, per subject, and per top-level subject category.
        </p>
      </div>
    </div>
  </div>
</div>

<!-- Autocomplete dropdown -->
<div id="autocomplete"></div>

<script>
// Storage abstraction
let storageMode = 'detecting'; // detecting, desktop, mobile
let folderHandle = null;
let currentFileHandle = null;
let currentFileName = null;
let studentsFileHandle = null;
let subjectsFileHandle = null;
let currentStudentFile = 'students.md';
let currentSubjectFile = 'subjects.md';
let studentFiles = {};
let subjectFiles = {};

// Timer state
let timerStartTime = null;
let timerLineIndex = null;
let timerPausedTime = null;
let timerState = 'idle';

// Data
let allHashtags = [];
let autocompleteSelectedIndex = -1;
let mobileData = {
  logs: {},
  students: '',
  subjects: ''
};

// Initialize
window.addEventListener('load', async () => {
  await detectPlatform();
  setupAutocomplete();
  updateStatus('üëà Ready to start tracking time!', 'idle');
});

// Platform detection
async function detectPlatform() {
  const hasFileSystemAccess = 'showDirectoryPicker' in window;

  if (hasFileSystemAccess) {
    storageMode = 'desktop';
    document.getElementById('storageModeIndicator').textContent = 'üíª Desktop Mode - Using folder storage';
    document.getElementById('storageModeIndicator').className = 'storage-mode desktop';
    document.getElementById('selectFolderBtn').classList.remove('hidden');
    document.getElementById('createFolderBtn').classList.remove('hidden');

    // Try to load from previous session (if permission granted)
    const savedFolder = localStorage.getItem('folderHandle');
    if (savedFolder) {
      updateStatus('Select your project folder to continue', 'idle');
    }
  } else {
    storageMode = 'mobile';
    document.getElementById('storageModeIndicator').textContent = 'üì± Mobile Mode - Using browser storage';
    document.getElementById('storageModeIndicator').className = 'storage-mode mobile';
    await loadFromLocalStorage();
    await loadTodayLog();
  }
}

// Desktop - File System Access API functions
async function selectFolder() {
  try {
    folderHandle = await window.showDirectoryPicker();
    await loadHashtags();
    await loadSettingsEditors();
    await refreshFileList();
    await loadTodayLog();
    updateStatus('‚úì Folder loaded successfully', 'idle');
  } catch(e) {
    if (e.name !== 'AbortError') {
      alert('Error selecting folder: ' + e.message);
    }
  }
}

async function createNewFolder() {
  try {
    folderHandle = await window.showDirectoryPicker();

    // Create folder structure
    const folders = ['Students', 'Subjects', 'Logbook', 'Templates'];
    for (const folderName of folders) {
      try {
        await folderHandle.getDirectoryHandle(folderName, { create: true });
      } catch(e) {
        console.log(`Folder ${folderName} may already exist`);
      }
    }

    // Create default students file
    const studentsFolder = await folderHandle.getDirectoryHandle('Students', { create: true });
    const studentsFile = await studentsFolder.getFileHandle('students.md', { create: true });
    const studentsWritable = await studentsFile.createWritable();
    await studentsWritable.write(`# Students

#student1 - First student
#student2 - Second student
`);
    await studentsWritable.close();

    // Create default subjects file
    const subjectsFolder = await folderHandle.getDirectoryHandle('Subjects', { create: true });
    const subjectsFile = await subjectsFolder.getFileHandle('subjects.md', { create: true });
    const subjectsWritable = await subjectsFile.createWritable();
    await subjectsWritable.write(`# Subjects

## Core Subjects
#core/math - Mathematics
#core/reading - Reading
#core/writing - Writing
#core/science - Science

## Electives
#elective/art - Art
#elective/music - Music
#elective/pe - Physical Education
`);
    await subjectsWritable.close();

    // Create template
    const templatesFolder = await folderHandle.getDirectoryHandle('Templates', { create: true });
    const templateFile = await templatesFolder.getFileHandle('Daily Log.md', { create: true });
    const templateWritable = await templateFile.createWritable();
    await templateWritable.write(`# {{date:YYYY-MM-DD}}

## Time Log

<!-- Add lines here -->
`);
    await templateWritable.close();

    alert('‚úì Folder structure created successfully!');
    await loadHashtags();
    await loadSettingsEditors();
    await createTodayLog();
  } catch(e) {
    if (e.name !== 'AbortError') {
      alert('Error creating folder: ' + e.message);
    }
  }
}

async function loadHashtags() {
  allHashtags = [];
  if (storageMode === 'desktop' && !folderHandle) return;

  if (storageMode === 'desktop') {
    const folders = ['Students', 'Subjects'];
    for (const folderName of folders) {
      try {
        const subfolderHandle = await folderHandle.getDirectoryHandle(folderName);
        for await (const entry of subfolderHandle.values()) {
          if (entry.kind === 'file' && entry.name.endsWith('.md')) {
            const fileHandle = await subfolderHandle.getFileHandle(entry.name);
            const file = await fileHandle.getFile();
            const content = await file.text();
            parseHashtagsFromText(content);
          }
        }
      } catch(e) {
        console.log(`Folder ${folderName} not found:`, e);
      }
    }
  } else {
    parseHashtagsFromText(mobileData.students + '\n' + mobileData.subjects);
  }
}

function parseHashtagsFromText(text) {
  const lines = text.split('\n');
  for (const line of lines) {
    const match = line.match(/^(#[\w\/]+)\s*-?\s*(.*)/);
    if (match) {
      allHashtags.push({ tag: match[1], desc: match[2].trim() });
    }
  }
}

async function loadSettingsEditors() {
  if (storageMode === 'desktop' && !folderHandle) return;

  if (storageMode === 'desktop') {
    // Load all student files
    studentFiles = {};
    try {
      const studentsFolder = await folderHandle.getDirectoryHandle('Students');
      for await (const entry of studentsFolder.values()) {
        if (entry.kind === 'file' && entry.name.endsWith('.md')) {
          const fileHandle = await studentsFolder.getFileHandle(entry.name);
          const file = await fileHandle.getFile();
          studentFiles[entry.name] = {
            handle: fileHandle,
            content: await file.text()
          };
        }
      }
    } catch(e) {
      console.log('Students folder not found:', e);
    }

    // Populate students dropdown
    const studentsSelect = document.getElementById('studentsFileSelect');
    studentsSelect.innerHTML = '';
    Object.keys(studentFiles).sort().forEach(filename => {
      const option = document.createElement('option');
      option.value = filename;
      option.textContent = filename;
      studentsSelect.appendChild(option);
    });

    // Load first student file
    if (Object.keys(studentFiles).length > 0) {
      currentStudentFile = Object.keys(studentFiles)[0];
      studentsSelect.value = currentStudentFile;
      document.getElementById('studentsEditor').value = studentFiles[currentStudentFile].content;
      studentsFileHandle = studentFiles[currentStudentFile].handle;
    }

    // Load all subject files
    subjectFiles = {};
    try {
      const subjectsFolder = await folderHandle.getDirectoryHandle('Subjects');
      for await (const entry of subjectsFolder.values()) {
        if (entry.kind === 'file' && entry.name.endsWith('.md')) {
          const fileHandle = await subjectsFolder.getFileHandle(entry.name);
          const file = await fileHandle.getFile();
          subjectFiles[entry.name] = {
            handle: fileHandle,
            content: await file.text()
          };
        }
      }
    } catch(e) {
      console.log('Subjects folder not found:', e);
    }

    // Populate subjects dropdown
    const subjectsSelect = document.getElementById('subjectsFileSelect');
    subjectsSelect.innerHTML = '';
    Object.keys(subjectFiles).sort().forEach(filename => {
      const option = document.createElement('option');
      option.value = filename;
      option.textContent = filename;
      subjectsSelect.appendChild(option);
    });

    // Load first subject file
    if (Object.keys(subjectFiles).length > 0) {
      currentSubjectFile = Object.keys(subjectFiles)[0];
      subjectsSelect.value = currentSubjectFile;
      document.getElementById('subjectsEditor').value = subjectFiles[currentSubjectFile].content;
      subjectsFileHandle = subjectFiles[currentSubjectFile].handle;
    }
  } else {
    document.getElementById('studentsEditor').value = mobileData.students;
    document.getElementById('subjectsEditor').value = mobileData.subjects;
  }
}

async function loadSelectedStudentFile() {
  const select = document.getElementById('studentsFileSelect');
  currentStudentFile = select.value;

  if (storageMode === 'desktop') {
    if (studentFiles[currentStudentFile]) {
      document.getElementById('studentsEditor').value = studentFiles[currentStudentFile].content;
      studentsFileHandle = studentFiles[currentStudentFile].handle;
    }
  }
}

async function loadSelectedSubjectFile() {
  const select = document.getElementById('subjectsFileSelect');
  currentSubjectFile = select.value;

  if (storageMode === 'desktop') {
    if (subjectFiles[currentSubjectFile]) {
      document.getElementById('subjectsEditor').value = subjectFiles[currentSubjectFile].content;
      subjectsFileHandle = subjectFiles[currentSubjectFile].handle;
    }
  }
}

async function createNewStudentFile() {
  const filename = prompt('Enter new student file name (e.g., students-team1.md):');
  if (!filename) return;

  const fullFilename = filename.endsWith('.md') ? filename : filename + '.md';

  if (storageMode === 'desktop') {
    if (!folderHandle) {
      alert('Please select a folder first');
      return;
    }

    try {
      const studentsFolder = await folderHandle.getDirectoryHandle('Students');
      const fileHandle = await studentsFolder.getFileHandle(fullFilename, { create: true });
      const writable = await fileHandle.createWritable();
      await writable.write('# Students\n\n#student - Description\n');
      await writable.close();

      await loadSettingsEditors();
      document.getElementById('studentsFileSelect').value = fullFilename;
      await loadSelectedStudentFile();
      alert('‚úì File created!');
    } catch(e) {
      alert('Error creating file: ' + e.message);
    }
  } else {
    alert('Multiple files only supported in desktop mode');
  }
}

async function createNewSubjectFile() {
  const filename = prompt('Enter new subject file name (e.g., subjects-math.md):');
  if (!filename) return;

  const fullFilename = filename.endsWith('.md') ? filename : filename + '.md';

  if (storageMode === 'desktop') {
    if (!folderHandle) {
      alert('Please select a folder first');
      return;
    }

    try {
      const subjectsFolder = await folderHandle.getDirectoryHandle('Subjects');
      const fileHandle = await subjectsFolder.getFileHandle(fullFilename, { create: true });
      const writable = await fileHandle.createWritable();
      await writable.write('# Subjects\n\n#subject - Description\n');
      await writable.close();

      await loadSettingsEditors();
      document.getElementById('subjectsFileSelect').value = fullFilename;
      await loadSelectedSubjectFile();
      alert('‚úì File created!');
    } catch(e) {
      alert('Error creating file: ' + e.message);
    }
  } else {
    alert('Multiple files only supported in desktop mode');
  }
}

async function deleteStudentFile() {
  if (!confirm(`Delete ${currentStudentFile}?`)) return;

  if (storageMode === 'desktop') {
    try {
      const studentsFolder = await folderHandle.getDirectoryHandle('Students');
      await studentsFolder.removeEntry(currentStudentFile);
      await loadSettingsEditors();
      await loadHashtags();
      alert('‚úì File deleted!');
    } catch(e) {
      alert('Error deleting file: ' + e.message);
    }
  }
}

async function deleteSubjectFile() {
  if (!confirm(`Delete ${currentSubjectFile}?`)) return;

  if (storageMode === 'desktop') {
    try {
      const subjectsFolder = await folderHandle.getDirectoryHandle('Subjects');
      await subjectsFolder.removeEntry(currentSubjectFile);
      await loadSettingsEditors();
      await loadHashtags();
      alert('‚úì File deleted!');
    } catch(e) {
      alert('Error deleting file: ' + e.message);
    }
  }
}

async function refreshFileList() {
  const fileList = document.getElementById('fileList');
  fileList.innerHTML = '';

  let files = [];

  if (storageMode === 'desktop' && folderHandle) {
    try {
      const logbookHandle = await folderHandle.getDirectoryHandle('Logbook');
      for await (const entry of logbookHandle.values()) {
        if (entry.kind === 'file' && entry.name.endsWith('.md')) {
          files.push(entry.name);
        }
      }
    } catch(e) {
      console.log('Logbook folder not found:', e);
    }
  } else if (storageMode === 'mobile') {
    files = Object.keys(mobileData.logs).map(date => date + '.md');
  }

  files.sort().reverse();

  if (files.length === 0) {
    const li = document.createElement('li');
    li.textContent = '(no logs yet)';
    li.style.fontStyle = 'italic';
    li.style.cursor = 'default';
    fileList.appendChild(li);
    return;
  }

  for (const filename of files) {
    const li = document.createElement('li');
    li.textContent = filename.replace('.md', '');
    li.onclick = () => loadLog(filename);
    if (filename === currentFileName) {
      li.className = 'active';
    }
    fileList.appendChild(li);
  }
}

async function loadLog(filename) {
  if (storageMode === 'desktop') {
    if (!folderHandle) return;
    try {
      const logbookHandle = await folderHandle.getDirectoryHandle('Logbook');
      currentFileHandle = await logbookHandle.getFileHandle(filename);
      const file = await currentFileHandle.getFile();
      const content = await file.text();
      document.getElementById('logEditor').value = content;
      document.getElementById('currentFile').textContent = filename;
      currentFileName = filename;
      await refreshFileList();
    } catch(e) {
      console.log('Error loading file:', e);
    }
  } else {
    const date = filename.replace('.md', '');
    const content = mobileData.logs[date] || `# ${date}\n\n## Time Log\n\n`;
    document.getElementById('logEditor').value = content;
    document.getElementById('currentFile').textContent = filename;
    currentFileName = filename;
    refreshFileList();
  }
}

async function loadTodayLog() {
  const today = new Date().toISOString().slice(0, 10) + '.md';
  await loadLog(today);
}

async function createTodayLog() {
  const today = new Date().toISOString().slice(0, 10);
  const filename = today + '.md';

  if (storageMode === 'desktop') {
    if (!folderHandle) {
      alert('Please select or create a folder first');
      return;
    }
    try {
      const logbookHandle = await folderHandle.getDirectoryHandle('Logbook');
      const fileHandle = await logbookHandle.getFileHandle(filename, { create: true });
      const file = await fileHandle.getFile();
      let content = await file.text();
      if (!content.trim()) {
        content = `# ${today}\n\n## Time Log\n\n`;
        const writable = await fileHandle.createWritable();
        await writable.write(content);
        await writable.close();
      }
      await loadLog(filename);
      await refreshFileList();
    } catch(e) {
      alert('Error creating log: ' + e.message);
    }
  } else {
    if (!mobileData.logs[today]) {
      mobileData.logs[today] = `# ${today}\n\n## Time Log\n\n`;
      saveToLocalStorage();
    }
    await loadLog(filename);
    refreshFileList();
  }
}

async function saveCurrentLog() {
  if (storageMode === 'desktop') {
    if (!currentFileHandle) {
      alert('No file loaded');
      return;
    }
    try {
      const content = document.getElementById('logEditor').value;
      const writable = await currentFileHandle.createWritable();
      await writable.write(content);
      await writable.close();
      updateStatus(`‚úì Saved ${currentFileName}`, 'idle');
    } catch(e) {
      alert('Error saving file: ' + e.message);
    }
  } else {
    const date = currentFileName.replace('.md', '');
    mobileData.logs[date] = document.getElementById('logEditor').value;
    saveToLocalStorage();
    updateStatus(`‚úì Saved ${currentFileName}`, 'idle');
  }
}

async function saveStudents() {
  const content = document.getElementById('studentsEditor').value;

  if (storageMode === 'desktop') {
    if (!studentsFileHandle) {
      alert('Students file not loaded');
      return;
    }
    try {
      const writable = await studentsFileHandle.createWritable();
      await writable.write(content);
      await writable.close();
      alert('‚úì Students saved!');
      await loadHashtags();
    } catch(e) {
      alert('Error saving: ' + e.message);
    }
  } else {
    mobileData.students = content;
    saveToLocalStorage();
    await loadHashtags();
    alert('‚úì Students saved!');
  }
}

async function saveSubjects() {
  const content = document.getElementById('subjectsEditor').value;

  if (storageMode === 'desktop') {
    if (!subjectsFileHandle) {
      alert('Subjects file not loaded');
      return;
    }
    try {
      const writable = await subjectsFileHandle.createWritable();
      await writable.write(content);
      await writable.close();
      alert('‚úì Subjects saved!');
      await loadHashtags();
    } catch(e) {
      alert('Error saving: ' + e.message);
    }
  } else {
    mobileData.subjects = content;
    saveToLocalStorage();
    await loadHashtags();
    alert('‚úì Subjects saved!');
  }
}

// Mobile - localStorage functions
function loadFromLocalStorage() {
  const saved = localStorage.getItem('homeschool-tracker-data');
  if (saved) {
    mobileData = JSON.parse(saved);
  } else {
    mobileData = {
      logs: {},
      students: `# Students\n\n#student1 - First student\n#student2 - Second student\n`,
      subjects: `# Subjects\n\n#core/math - Mathematics\n#core/reading - Reading\n#elective/art - Art\n`
    };
    saveToLocalStorage();
  }

  document.getElementById('studentsEditor').value = mobileData.students;
  document.getElementById('subjectsEditor').value = mobileData.subjects;
  parseHashtagsFromText(mobileData.students + '\n' + mobileData.subjects);
  refreshFileList();
}

function saveToLocalStorage() {
  localStorage.setItem('homeschool-tracker-data', JSON.stringify(mobileData));
}

// JSON Import/Export
async function exportJSON() {
  let data;

  if (storageMode === 'desktop') {
    if (!folderHandle) {
      alert('Please select a folder first');
      return;
    }

    // Collect all data from folder
    data = {
      logs: {},
      students: document.getElementById('studentsEditor').value,
      subjects: document.getElementById('subjectsEditor').value
    };

    try {
      const logbookHandle = await folderHandle.getDirectoryHandle('Logbook');
      for await (const entry of logbookHandle.values()) {
        if (entry.kind === 'file' && entry.name.endsWith('.md')) {
          const fileHandle = await logbookHandle.getFileHandle(entry.name);
          const file = await fileHandle.getFile();
          const content = await file.text();
          const date = entry.name.replace('.md', '');
          data.logs[date] = content;
        }
      }
    } catch(e) {
      console.log('Error reading logs:', e);
    }
  } else {
    data = mobileData;
  }

  const dataStr = JSON.stringify(data, null, 2);
  const blob = new Blob([dataStr], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `homeschool-data-${new Date().toISOString().slice(0,10)}.json`;
  a.click();
  URL.revokeObjectURL(url);

  updateStatus('‚úì Data exported to JSON', 'idle');
}

function importJSON() {
  document.getElementById('jsonFileInput').click();
}

async function handleJSONImport(event) {
  const file = event.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = async (e) => {
    try {
      const data = JSON.parse(e.target.result);

      if (!confirm('This will merge/overwrite current data. Continue?')) {
        return;
      }

      if (storageMode === 'desktop') {
        if (!folderHandle) {
          alert('Please select a folder first');
          return;
        }

        // Import students
        if (data.students) {
          document.getElementById('studentsEditor').value = data.students;
          await saveStudents();
        }

        // Import subjects
        if (data.subjects) {
          document.getElementById('subjectsEditor').value = data.subjects;
          await saveSubjects();
        }

        // Import logs
        if (data.logs) {
          const logbookHandle = await folderHandle.getDirectoryHandle('Logbook', { create: true });
          for (const [date, content] of Object.entries(data.logs)) {
            const filename = date + '.md';
            const fileHandle = await logbookHandle.getFileHandle(filename, { create: true });
            const writable = await fileHandle.createWritable();
            await writable.write(content);
            await writable.close();
          }
        }

        await refreshFileList();
        await loadTodayLog();
        alert('‚úì Data imported successfully!');
      } else {
        mobileData = data;
        saveToLocalStorage();
        loadFromLocalStorage();
        await loadTodayLog();
        alert('‚úì Data imported successfully!');
      }
    } catch(err) {
      alert('Error importing file: ' + err.message);
    }
  };
  reader.readAsText(file);

  // Clear the input
  event.target.value = '';
}

// CSV Export with time calculations
async function exportCSV() {
  let allLogs = {};

  // Collect all log data
  if (storageMode === 'desktop') {
    if (!folderHandle) {
      alert('Please select a folder first');
      return;
    }

    try {
      const logbookHandle = await folderHandle.getDirectoryHandle('Logbook');
      for await (const entry of logbookHandle.values()) {
        if (entry.kind === 'file' && entry.name.endsWith('.md')) {
          const fileHandle = await logbookHandle.getFileHandle(entry.name);
          const file = await fileHandle.getFile();
          const content = await file.text();
          const date = entry.name.replace('.md', '');
          allLogs[date] = content;
        }
      }
    } catch(e) {
      console.log('Error reading logs:', e);
    }
  } else {
    allLogs = mobileData.logs;
  }

  // Parse all time entries
  const rows = [];
  const studentTotals = {};
  const subjectTotals = {};
  const topLevelSubjectTotals = {};

  for (const [date, content] of Object.entries(allLogs)) {
    const lines = content.split('\n');

    for (let i = 0; i < lines.length; i++) {
      const line = lines[i];

      // Match time log entries: - HH:MM ‚Äì HH:MM ‚Üí #tags
      const match = line.match(/^-\s*(\d{1,2}:\d{2})\s*[‚Äì-]\s*(\d{1,2}:\d{2})\s*‚Üí\s*(.+)/);
      if (match) {
        const startTime = match[1];
        const endTime = match[2];
        const tagsAndNotes = match[3];

        // Calculate duration in minutes
        const duration = calculateDuration(startTime, endTime);

        // Extract hashtags
        const tags = tagsAndNotes.match(/#[\w\/]+/g) || [];
        const students = [];
        const subjects = [];

        tags.forEach(tag => {
          // Simple heuristic: if it has a slash, it's probably a subject
          // Otherwise, check if it matches known patterns
          if (tag.includes('/')) {
            subjects.push(tag);
          } else {
            // Check if tag starts with common subject prefixes
            if (tag.match(/^#(core|elective|math|reading|writing|science|history|latin|spanish|art|music|pe|piano|readaloud|cooking|chores)/i)) {
              subjects.push(tag);
            } else {
              students.push(tag);
            }
          }
        });

        // Get notes from next line if indented
        let notes = '';
        if (i + 1 < lines.length && lines[i + 1].match(/^\s+\w/)) {
          notes = lines[i + 1].trim();
        }

        // Create rows for each student-subject combination
        if (students.length === 0) students.push('#unknown');
        if (subjects.length === 0) subjects.push('#unspecified');

        students.forEach(student => {
          subjects.forEach(subject => {
            rows.push({
              date,
              student: student.substring(1),
              subject: subject.substring(1),
              startTime,
              endTime,
              duration,
              notes
            });

            // Add to totals
            if (!studentTotals[student]) studentTotals[student] = 0;
            studentTotals[student] += duration;

            if (!subjectTotals[subject]) subjectTotals[subject] = 0;
            subjectTotals[subject] += duration;

            // Add to top-level subject totals
            const topLevel = subject.includes('/') ? '#' + subject.split('/')[0].substring(1) : subject;
            if (!topLevelSubjectTotals[topLevel]) topLevelSubjectTotals[topLevel] = 0;
            topLevelSubjectTotals[topLevel] += duration;
          });
        });
      }
    }
  }

  // Generate CSV
  let csv = 'Date,Student,Subject,Start,End,Duration (min),Notes\n';

  rows.forEach(row => {
    csv += `${row.date},${row.student},${row.subject},${row.startTime},${row.endTime},${row.duration},"${row.notes}"\n`;
  });

  // Add summary section
  csv += '\n\n=== TOTALS BY STUDENT ===\n';
  csv += 'Student,Total Hours\n';
  Object.entries(studentTotals)
    .sort((a, b) => b[1] - a[1])
    .forEach(([student, minutes]) => {
      csv += `${student.substring(1)},${(minutes / 60).toFixed(2)}\n`;
    });

  csv += '\n\n=== TOTALS BY SUBJECT ===\n';
  csv += 'Subject,Total Hours\n';
  Object.entries(subjectTotals)
    .sort((a, b) => b[1] - a[1])
    .forEach(([subject, minutes]) => {
      csv += `${subject.substring(1)},${(minutes / 60).toFixed(2)}\n`;
    });

  csv += '\n\n=== TOTALS BY TOP-LEVEL SUBJECT ===\n';
  csv += 'Subject Category,Total Hours\n';
  Object.entries(topLevelSubjectTotals)
    .sort((a, b) => b[1] - a[1])
    .forEach(([subject, minutes]) => {
      csv += `${subject.substring(1)},${(minutes / 60).toFixed(2)}\n`;
    });

  // Download CSV
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `homeschool-time-report-${new Date().toISOString().slice(0,10)}.csv`;
  a.click();
  URL.revokeObjectURL(url);

  updateStatus(`‚úì CSV exported with ${rows.length} entries`, 'idle');
}

function calculateDuration(startTime, endTime) {
  // Parse times in format HH:MM or H:MM
  const parseTime = (timeStr) => {
    const [hours, minutes] = timeStr.split(':').map(Number);
    return hours * 60 + minutes;
  };

  const start = parseTime(startTime);
  let end = parseTime(endTime);

  // Handle times crossing midnight
  if (end < start) {
    end += 24 * 60;
  }

  return end - start;
}

// Timer functions
function insertTimerLine() {
  const editor = document.getElementById('logEditor');
  const cursorPos = editor.selectionStart;
  const content = editor.value;

  let insertPos = cursorPos;
  while (insertPos < content.length && content[insertPos] !== '\n') {
    insertPos++;
  }

  const prefix = (insertPos < content.length || content[insertPos - 1] === '\n') ? '' : '\n';
  const newLine = `${prefix}- [Timer] #student #subject\n  `;

  editor.value = content.slice(0, insertPos) + newLine + content.slice(insertPos);
  editor.selectionStart = editor.selectionEnd = insertPos + newLine.length;
  editor.focus();

  updateStatus('Timer entry inserted - add tags and click Start', 'idle');
}

function startTimer() {
  const editor = document.getElementById('logEditor');
  const lines = editor.value.split('\n');

  if (timerState === 'paused') {
    timerState = 'running';
    document.getElementById('startBtn').textContent = '‚ñ∂Ô∏è Start Timer';
    updateTimerButtons();
    const content = lines[timerLineIndex].replace('- [Timer]', '').trim();
    updateStatus(`‚è±Ô∏è RUNNING (resumed)... ${content}`, 'running');
    return;
  }

  let timerLine = -1;
  for (let i = lines.length - 1; i >= 0; i--) {
    if (lines[i].includes('[Timer]')) {
      timerLine = i;
      break;
    }
  }

  if (timerLine === -1) {
    alert('No [Timer] entry found. Click "New Timer Entry" or type: - [Timer] #tags');
    return;
  }

  timerStartTime = new Date();
  timerLineIndex = timerLine;
  timerState = 'running';
  updateTimerButtons();

  const content = lines[timerLine].replace('- [Timer]', '').trim();
  updateStatus(`‚è±Ô∏è RUNNING... Started at ${timerStartTime.toLocaleTimeString()} - ${content}`, 'running');
}

function pauseTimer() {
  if (timerState !== 'running') return;
  timerState = 'paused';
  timerPausedTime = new Date();
  updateTimerButtons();
  updateStatus('‚è∏Ô∏è PAUSED - Click Start to resume or Stop to finish', 'idle');
}

function stopTimer() {
  if (!timerStartTime || timerLineIndex === null) {
    alert('No timer running');
    return;
  }

  const endTime = new Date();
  const startStr = timerStartTime.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
  const endStr = endTime.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

  const editor = document.getElementById('logEditor');
  const lines = editor.value.split('\n');

  if (timerLineIndex < lines.length && lines[timerLineIndex].includes('[Timer]')) {
    lines[timerLineIndex] = lines[timerLineIndex].replace('[Timer]', `${startStr} ‚Äì ${endStr} ‚Üí`);
    editor.value = lines.join('\n');
    saveCurrentLog();
    updateStatus(`‚úì Saved: ${startStr} ‚Äì ${endStr}`, 'idle');
  } else {
    alert('Timer entry was modified or deleted');
  }

  timerStartTime = null;
  timerLineIndex = null;
  timerPausedTime = null;
  timerState = 'idle';
  document.getElementById('startBtn').textContent = '‚ñ∂Ô∏è Start Timer';
  updateTimerButtons();
}

function updateTimerButtons() {
  const startBtn = document.getElementById('startBtn');
  const pauseBtn = document.getElementById('pauseBtn');
  const stopBtn = document.getElementById('stopBtn');

  if (timerState === 'idle') {
    startBtn.classList.remove('hidden');
    pauseBtn.classList.add('hidden');
    stopBtn.classList.add('hidden');
  } else if (timerState === 'running') {
    startBtn.classList.add('hidden');
    pauseBtn.classList.remove('hidden');
    stopBtn.classList.remove('hidden');
  } else if (timerState === 'paused') {
    startBtn.classList.remove('hidden');
    startBtn.textContent = '‚ñ∂Ô∏è Resume Timer';
    pauseBtn.classList.add('hidden');
    stopBtn.classList.remove('hidden');
  }
}

// Autocomplete
function setupAutocomplete() {
  const editor = document.getElementById('logEditor');

  editor.addEventListener('input', (e) => {
    const cursorPos = editor.selectionStart;
    const text = editor.value;

    let hashStart = cursorPos - 1;
    let currentWord = '';

    while (hashStart >= 0 && text[hashStart] !== ' ' && text[hashStart] !== '\n' && text[hashStart] !== '\t') {
      currentWord = text[hashStart] + currentWord;
      hashStart--;
    }

    if (currentWord.startsWith('#') && currentWord.length > 1) {
      const prefix = currentWord.substring(1);
      showAutocomplete(prefix);
    } else {
      hideAutocomplete();
    }
  });

  // Handle keyboard navigation
  editor.addEventListener('keydown', (e) => {
    const dropdown = document.getElementById('autocomplete');
    if (dropdown.style.display !== 'block') return;

    if (e.key === 'ArrowDown') {
      e.preventDefault();
      const items = dropdown.querySelectorAll('div');
      autocompleteSelectedIndex = Math.min(autocompleteSelectedIndex + 1, items.length - 1);
      updateAutocompleteSelection();
    } else if (e.key === 'ArrowUp') {
      e.preventDefault();
      autocompleteSelectedIndex = Math.max(autocompleteSelectedIndex - 1, 0);
      updateAutocompleteSelection();
    } else if (e.key === 'Enter') {
      const items = dropdown.querySelectorAll('div');
      if (autocompleteSelectedIndex >= 0 && autocompleteSelectedIndex < items.length) {
        e.preventDefault();
        items[autocompleteSelectedIndex].click();
      }
    } else if (e.key === 'Escape') {
      e.preventDefault();
      hideAutocomplete();
    }
  });
}

function showAutocomplete(prefix) {
  const dropdown = document.getElementById('autocomplete');
  const editor = document.getElementById('logEditor');

  const filtered = allHashtags.filter(h =>
    h.tag.toLowerCase().startsWith('#' + prefix.toLowerCase())
  );

  if (filtered.length === 0) {
    hideAutocomplete();
    return;
  }

  dropdown.innerHTML = '';
  filtered.forEach((item, index) => {
    const div = document.createElement('div');
    div.innerHTML = `<span class="tag">${item.tag}</span><span class="desc">${item.desc}</span>`;
    div.onclick = () => insertHashtag(item.tag);
    dropdown.appendChild(div);
  });

  // Position dropdown
  const editorRect = editor.getBoundingClientRect();
  dropdown.style.left = Math.max(10, editorRect.left) + 'px';
  dropdown.style.top = (editorRect.top + 60) + 'px';
  dropdown.style.display = 'block';

  autocompleteSelectedIndex = 0;
  updateAutocompleteSelection();
}

function hideAutocomplete() {
  document.getElementById('autocomplete').style.display = 'none';
  autocompleteSelectedIndex = -1;
}

function updateAutocompleteSelection() {
  const dropdown = document.getElementById('autocomplete');
  const items = dropdown.querySelectorAll('div');

  items.forEach((item, index) => {
    if (index === autocompleteSelectedIndex) {
      item.classList.add('selected');
      item.scrollIntoView({ block: 'nearest' });
    } else {
      item.classList.remove('selected');
    }
  });
}

function insertHashtag(tag) {
  const editor = document.getElementById('logEditor');
  const cursorPos = editor.selectionStart;
  const text = editor.value;

  let hashStart = cursorPos - 1;
  while (hashStart >= 0 && text[hashStart] !== '#' && text[hashStart] !== ' ' && text[hashStart] !== '\n') {
    hashStart--;
  }

  if (text[hashStart] === '#') {
    editor.value = text.substring(0, hashStart) + tag + ' ' + text.substring(cursorPos);
    editor.selectionStart = editor.selectionEnd = hashStart + tag.length + 1;
  }

  hideAutocomplete();
  editor.focus();
}

// UI functions
function switchTab(tabName) {
  document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));

  if (tabName === 'logs') {
    document.getElementById('logsTab').classList.add('active');
    document.querySelectorAll('.tab')[0].classList.add('active');
  } else if (tabName === 'settings') {
    document.getElementById('settingsTab').classList.add('active');
    document.querySelectorAll('.tab')[1].classList.add('active');
  }
}

function updateStatus(message, type = 'idle') {
  const status = document.getElementById('status');
  status.textContent = message;
  status.className = type;
}

// Click outside autocomplete to close
document.addEventListener('click', (e) => {
  if (!e.target.closest('#autocomplete') && !e.target.closest('#logEditor')) {
    hideAutocomplete();
  }
});
</script>

<div class="footer">
<p><strong>A tool from the <a href="https://azirona.com">Azirona Drift</a></strong></p>
<p style="font-size: 14px; margin-top: 10px;">Made with ‚ù§Ô∏è for homeschool families | Open Source | Free Forever</p>
</div>

</body>
</html>
